From: Hybrid Patch for Desktop GL Fix
Subject: Add NSOpenGLContext support for working Desktop GL (gl=core)

This patch modifies qemu-virgl3d-macos.patch to use NSOpenGLContext
for Desktop GL initialization instead of CGL, which fixes the black
screen issue. The OpenGL ES (gl=es) path with ANGLE Metal remains
unchanged.

diff --git a/ui/cocoa.m b/ui/cocoa.m
--- a/ui/cocoa.m
+++ b/ui/cocoa.m
@@ -108,6 +108,7 @@
 static uint32_t gl_scanout_id;
 static bool gl_scanout_y0_top;
 static QEMUGLContext gl_view_ctx;
+static NSOpenGLContext *gl_view_nsctx;

 #ifdef CONFIG_EGL
 static EGLSurface egl_surface;
@@ -178,6 +179,7 @@
             forLayerTime:(CFTimeInterval)t
              displayTime:(const CVTimeStamp *)ts
 {
+    CGLSetCurrentContext(ctx);
     BQL_LOCK_GUARD();
     cocoa_gl_render();

@@ -188,6 +190,26 @@
 }
 @end

+static NSOpenGLContext *cocoa_gl_create_nscontext(int bpp)
+{
+    NSOpenGLPixelFormatAttribute attrs[] = {
+        NSOpenGLPFAOpenGLProfile, NSOpenGLProfileVersion3_2Core,
+        NSOpenGLPFAColorSize, (NSOpenGLPixelFormatAttribute)bpp,
+        NSOpenGLPFADoubleBuffer,
+        0
+    };
+
+    NSOpenGLPixelFormat *pf = [[NSOpenGLPixelFormat alloc] initWithAttributes:attrs];
+    if (!pf) {
+        return nil;
+    }
+
+    NSOpenGLContext *ctx = [[NSOpenGLContext alloc] initWithFormat:pf
+                                                       shareContext:nil];
+    [pf release];
+    return ctx;
+}
+
 #endif

 // Utility functions to run specified code block with the BQL held
@@ -2447,11 +2469,12 @@
             exit(1);
 #endif
         } else {
-            CGLPixelFormatObj format = cocoa_gl_create_cgl_pixel_format(32);
-            CGLContextObj ctx;
-            CGLCreateContext(format, NULL, &ctx);
-            CGLDestroyPixelFormat(format);
-            gl_view_ctx = (QEMUGLContext)ctx;
+            gl_view_nsctx = cocoa_gl_create_nscontext(32);
+            if (!gl_view_nsctx) {
+                exit(1);
+            }
+            [gl_view_nsctx makeCurrentContext];
+            gl_view_ctx = (QEMUGLContext)[gl_view_nsctx CGLContextObj];
 #ifdef CONFIG_EGL
             egl_surface = EGL_NO_SURFACE;
 #endif
